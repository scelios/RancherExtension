<template>
    <div class="extension-container">
        <!-- Dynamic Title -->
        <h1>Events for {{ resourceKind }}: {{ resourceName }}</h1>
        
        <button @click="slidein">Slide</button>
        <div v-if="isLoading">Loading events...</div>
        
        <div v-else-if="errorMessage" class="error">{{ errorMessage }}</div>

        <div v-else-if="events.length === 0">No events found for this resource.</div>
        <table v-else class="event-table">
            <thead>
                <tr>
                    <th @click="sortBy('name')" style="cursor: pointer">
                        Resource Name 
                        <span class="sort-icon" :class="{ active: sortKey === 'name' }">
                            {{ sortKey === 'name' ? (sortOrder === 'asc' ? '▲' : '▼') : '⇅' }}
                        </span>
                    </th>
                    <th @click="sortBy('description')" style="cursor: pointer">
                        Message
                        <span class="sort-icon" :class="{ active: sortKey === 'description' }">
                            {{ sortKey === 'description' ? (sortOrder === 'asc' ? '▲' : '▼') : '⇅' }}
                        </span>
                    </th>
                    <th @click="sortBy('date')" style="cursor: pointer">
                        Last Seen
                        <span class="sort-icon" :class="{ active: sortKey === 'date' }">
                            {{ sortKey === 'date' ? (sortOrder === 'asc' ? '▲' : '▼') : '⇅' }}
                        </span>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(event, index) in sortedEvents" :key="event.id || index">
                    <td>
                        <b>{{ event.kind }}</b>: {{ event.name }}
                    </td>
                    <td>
                        <span :class="{'text-danger': event.type === 'Warning'}">
                            [{{ event.reason }}]
                        </span> 
                        {{ event.description }}
                    </td>
                    <td>{{ event.date }}</td>
                    <td>{{ event.kind }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</template>

<script>
import pop from './pop.vue';
export default {
    
    props: {
        resource: {
            type: Object,
            required: true
        }
    },
    data() {
        return {
            isLoading: false,
            errorMessage: '',
            sortKey: 'date',
            sortOrder: 'desc',
            events: [] 
        };
    },
    computed: {
        // Helpers to get cleaner names from the prop
        resourceName() {
            return this.resource?.metadata?.name || '';
        },
        resourceNamespace() {
            return this.resource?.metadata?.namespace || '';
        },
        resourceKind() {
            return this.resource?.kind || '';
        },
        sortedEvents() {
            return this.events.slice().sort((a, b) => {
                let modifier = 1;
                if (this.sortOrder === 'desc') modifier = -1;
                
                const valA = (a[this.sortKey] || '').toString();
                const valB = (b[this.sortKey] || '').toString();

                if (valA < valB) return -1 * modifier;
                if (valA > valB) return 1 * modifier;
                return 0;
            });
        }
    },

    async mounted() {
        await this.fetchEvents();
    },

    // Re-fetch if the user creates a new event or switches tabs
    watch: {
        resource() {
            this.fetchEvents();
        }
    },

    methods: {
        slidein() {
            this.$shell.slideIn.open(pop, {
                title: 'My Slide-in'
            });
            console.log("Slide-in opened");
        },

        async fetchEvents() {
            this.isLoading = true;
            this.errorMessage = '';
            
            try {
                const allEvents = await this.$store.dispatch('cluster/findAll', { type: 'event' });

                const filteredList = allEvents.filter(evt => {
                    const involved = evt.involvedObject;
                    if (!involved) return false;

                    // Special handling for Namespace events: we want to include 
                    // events that are either about the Namespace itself OR events that occur within that Namespace
                    if (this.resourceKind === 'Namespace') {
                        return (involved.namespace === this.resourceName) || 
                               (involved.kind === 'Namespace' && involved.name === this.resourceName);
                    }

                    if ((this.resourceNamespace && involved.namespace !== this.resourceNamespace)
                        || (involved.name !== this.resourceName)
                        || (involved.kind.toLowerCase() !== this.resourceKind.toLowerCase()))
                        {
                        return false;
                    }

                    return true;
                });

                console.log("DEBUG: Matching events:", filteredList);

                this.events = filteredList.map(evt => {
                    return {
                        id: evt.id,
                        name: evt.involvedObject.name, 
                        kind: evt.involvedObject.kind,
                        description: evt.message || '',
                        reason: evt.reason || 'Info',
                        type: evt.type || 'Normal',
                        date: evt.lastTimestamp || evt.firstTimestamp
                    };
                });

            } catch (err) {
                this.errorMessage = `Error: ${err.message}`;
            } finally {
                this.isLoading = false;
            }
        },
        sortBy(key) {
            if (this.sortKey === key) {
                this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortKey = key;
                this.sortOrder = 'asc';
            }
        }
    }
};
</script>

<style scoped>
.extension-container {
    padding: 20px;
    font-family: sans-serif;
}

.error {
    color: #dc3545;
    padding: 10px;
    background: #ffe6e6;
    border-radius: 4px;
}

.text-danger {
    color: #dc3545;
    font-weight: bold;
}

.event-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.event-table th, .event-table td {
    border: 1px solid #f5f7fa;
    padding: 8px;
    text-align: left;
}

.event-table th {
    background-color: #f5f7fa;
    color: #333;
}

.sort-icon {
    float: right;
    margin-left: 5px;
    color: #aeadad; /* Faint color for inactive */
    font-size: 0.8em;
}

.sort-icon.active {
    color: #333;
    font-weight: bold;
}
</style>